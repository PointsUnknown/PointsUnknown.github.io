<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-108699112-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-108699112-1');
  </script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="../../favicon.ico">
  <title>Points Unknown</title>

  <!-- Bootstrap -->
  <link href="../css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="../css/site-specific.css" rel="stylesheet">

  <!-- Google fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:300,400,500|Roboto:300,300i,400,400i" rel="stylesheet">

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body data-spy="scroll" data-target="#myScrollspy" data-offset="10">
  <!-- Fixed navbar -->
  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">Points Unknown</a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">
          <!-- <li class="active"><a href="#">Home</a></li> -->
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Courses <span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a href="../journalism_fall2017.html">Journalism - Fall 2017</a></li>
              <li><a href="../journalism_spring2018a.html">Journalism - Spring 2018 (A)</a></li>
              <li><a href="../journalism_spring2018b.html">Journalism - Spring 2018 (B)</a></li>
              <li><a href="../gsapp_spring2018.html">GSAPP - Spring 2018</a></li>
            </ul>
          </li>
          <li class="dropdown active">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Tutorials <span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a href="00_InstallationInstructions.html">00 - Installation Instructions</a></li>
              <li><a href="01_BasicMap.html">01 - Basic Map</a></li>
              <li><a href="02_AnnotationLayer.html">02 - Annotation Layers</a></li>
              <li><a href="03_PointData.html">03 - Working with Point Data</a></li>
              <li><a href="04_CensusJoins.html">04 - Working with Census Data</a></li>
              <li><a href="05_ChangeMapping.html">05 - Change Mapping</a></li>
              <li><a href="06_Geocoding.html">06 - Geocoding</a></li>
              <li><a href="07_SpatialStatistics.html">07 - Spatial Statistics</a></li>
              <li><a href="08_MCDA.html">08 - Multi-Criteria Decision Analysis</a></li>
            </ul>
          </li>
          <li><a href="../apply.html">Apply</a></li>
          <li><a href="../resources.html">Resources</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </nav>
  <div class="jumbotron">
    <div class="container">
      <h1>Tutorial 06 - Geocoding Addresses</h1>
      <p>This tutorial will guide you through the process of taking address data and converting it to points on a map. To do this you will use the MMQGIS plugin, which
        can access either the Google Maps Geocoding API or the OpenStreetMap Nominatum API.</p>
    </div>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-md-9" role="main">
        <div class="section">
          <span class="anchor" id="datasets"></span>
          <h1 class="page-header">
            Datasets
          </h1>
          <p>For this tutorial we will be using the following datasets:</p>
          <ul>
            <li><p>Boroughs - New York City boroughs. Download from <a href="http://www1.nyc.gov/site/planning/data-maps/open-data/districts-download-metadata.page">NYC Planning - Open Data</a>. Choose "Borough Boundaries (Clipped to Shoreline)", under "Borough Boundaries &amp; Community Districts".</p></li>
            <li><p>NYC Parking Violations - Stopping, standing or parking within a marked bicycle lane. Downloaded from <a href="https://opendata.cityofnewyork.us/">NYC OpenData</a>.</p></li>
          </ul>
        </div>
        <div class="section">
          <span class="anchor" id="whatIsGeocoding"></span>
          <h1 class="page-header">What is Geocoding</h1>
          <p>Geocoding is the process of taking address data and locating it on a map, giving it geographic coordinates. This process,
            as simple as it sounds, requires two important things: first, that the addresses be properly formatted, and second,
            a detailed street database, containing the names of all streets, as well as the numbering for each street segment.<br><br>In the past
            geocoding involved taking a street database, such as the <a href="https://www1.nyc.gov/site/planning/data-maps/open-data/dwn-lion.page">LION Single Line Street Base Map</a>,
            and using ArcGIS to build a "street locator" file which would act like a dictionary for the street database. Once the "locator" file
            was built, ArcGIS would be able to place the addresses on the map based on the street database.<br><br>Even though this process is still
            in use, for smaller datasets there are simpler alternatives that use QGIS and bypass getting a detailed street database, as well as
            building the "street locator" file. In this tutorial, we will use the <a href="http://michaelminn.com/linux/mmqgis/">MMQGIS</a> plugin
            for QGIS, which accesses either the <a href="https://developers.google.com/maps/documentation/geocoding/start">Google Maps Geocoding API</a> or the <a href="https://operations.osmfoundation.org/policies/nominatim/">OpenStreetMap/Nominatum API</a>. The big drawback is that both
            these APIs have limits on the number of addresses you can geocode. In the case of the Nominatum API, there is a limit of
            1 request per second, and in the case of the Google Maps Geocoding API there is a limit of 50 requests per minute and a maximum
            of 2,500 requests per day (per API key).<br><br>Even though these limits seem not too stringent, once you have a dataset of a few thousand
            addresses you will start facing difficulties. Just as an example, take the dataset of parking violations for New York City for
            just October 12, 2016, which contains almost 30,000 entries. If you were to use the Google Maps Geocoding API, it would take
            over 10 days at a rate of 2,500 requests per day; or if you used the Nominatum API, it would take more than 8 hours. If you need to geocode
            a large amount of addresses, the classic way, using ArcGIS, might still be the most efficient way.</p>
        </div>
        <div class="section">
          <span class="anchor" id="downloadParking"></span>
          <h1 class="page-header">Filtering and Downloading Parking Violations</h1>
          <ul>
            <li><p>The first step in this tutorial is to select, filter and download the parking violation data. Just like in
              the <a href="04_PointData.html">working with point data tutorial</a> we will use the
              <a href="https://opendata.cityofnewyork.us/">NYC OpenData portal</a> to access, filter and download the data.
              The main dataset we are looking for is called <code>Parking Violations Issued - Fiscal Year 2017</code>. Once you
              click there , select <code>View Data</code> from the <code>Explore Data</code> dropdown menu.</p></li>
            <li><p>Ideally, we would use the whole dataset, but because of the geocoding rate limits we will have to filter the
              dataset and just use violations related to parking on a bike lane for October 12, 2016. I have chosen that day for no particular
              reason other than it is a weekday.</p></li>
            <li><p>You probably also want to check out the <code>DOF Parking Violation Codes</code> file, which explains
              all the different codes for parking violations. We will be using code <code>48</code>, which relates to
              <code>Stopping, standing or parking within a marked bicycle lane.</code></p></li>
            <li><p>Just like on the <a href="04_PointData.html">working with point data tutorial</a> you should create two filters to select just the data we want:</p></li>
            <ul>
              <li><p><code>Violation Code</code> <code>is</code> <code>48</code></p></li>
              <li><p><code>Issue Date</code> <code>is</code> <code>10/12/2016</code></p></li>
            </ul>
            <li><p>Finally, click on the <code>Export</code> button at the top right-hand corner of the site and choose the <code>CSV</code> (comma separated values) format. Your file should start downloading then.</p></li>
            <li><p>If you open your .csv file in Excel or Google Sheets you will see that there are about 390 records.</p></li>
          </ul>
        </div>
        <div class="section">
          <span class="anchor" id="formattingAddresses"></span>
          <h1 class="page-header">Formatting Address Data</h1>
          <p>Most geocoding services take addresses in a specific format, something like <code>Address</code> <code>City</code> <code>Zip code</code> <code>County</code> <code>State</code> <code>Country</code>, or a variation of this.
            So the first thing we need to do is make sure the dataset we just downloaded has a much address information as possible in the right format. For this we will use either Microsoft Excel or Google Sheets.</p>
          <ul>
            <li><p>First, open your dataset in Excel or Google Sheets</p></li>
            <li><p>You will notice that the dataset has a column for <code>Violation County</code>, another for <code>House Number</code> and another for <code>Street Name</code>.
              Now, we know that all of these traffic violations occurred in New York City and in New York State, so we can just infer those. However, we still need to
              combine the <code>House Number</code> and the <code>Street Name</code> into one field and transform the <code>Violation County</code> data into something more than just the initials of the counties.</p></li>
            <li><p>Start by adding 4 new columns to your spreadsheet. It doesn't really matter where you add them (I'm adding them right after the <code>Street Name</code> field).
              Name these columns <code>Address</code>, <code>City</code>, <code>State</code>, and <code>County</code>.</p></li>
            <li><p>Now you need to combine the <code>House Number</code> column with the <code>Street Name</code> one. This operations is called a
              concatenation. In the first <code>Address</code> cell, write the following formula <code>=X2&" "&Y2</code>. Here, <code>X2</code> and <code>Y2</code>
              refer to the cells where the <code>House Number</code> and <code>Street Name</code> fields are located. Verify that this formula
              worked for the first cell and copy it to the rest of the column.</p></li>
            <li><p>Once you've copied the formula for the rest of the cells in the column (and it has worked), you need to select the whole column
              <code>Copy</code> it and in the same location <code>right click</code> and choose <code>Paste Special</code> and then <code>Values</code>.
              That way you are making sure that the new values are hard-coded and not a formula anymore.</p></li>
            <li><p>For the <code>City</code> and <code>State</code> fields you can just fill them in with <code>New York</code> and <code>NY</code> respectively.</p></li>
            <li><p>Finally, the process to fill in the <code>County</code> field is a little more complex:</p></li>
            <ul>
              <li><p>First, if you take a look at the <code>Violation County</code> column, you will notice that the way the counties have been coded is not consistent.
                For example, some of the entries for Brooklyn have been coded as <code>Bk</code> and others as <code>K</code>, which stands for "Kings County".
                To solve this and to make all the county codes consistent we need to build a small table and use the <code>VLOOKUP</code> function.</p></li>
              <li><p>In a separate part of your spreadsheet (I'm doing this on the right hand side), create the following table:</p></li>
              <table>
                <tr><td><p>BK</p></td><td><p>Kings</p></td></tr>
                <tr><td><p>BX</p></td><td><p>Bronx</p></td></tr>
                <tr><td><p>K</p></td><td><p>Kings</p></td></tr>
                <tr><td><p>MN</p></td><td><p>New York</p></td></tr>
                <tr><td><p>NY</p></td><td><p>New York</p></td></tr>
                <tr><td><p>Q</p></td><td><p>Queens</p></td></tr>
                <tr><td><p>QN</p></td><td><p>Queens</p></td></tr>
                <tr><td><p>R</p></td><td><p>Richmond</p></td></tr>
                <tr><td><p>ST</p></td><td><p>Richmond</p></td></tr>
              </table>
              <li><p>These are all the variations of the county names in the table and their corresponding value. Now we need to
                write the formula stating that when you find the value on the left, in the <code>Violation County</code> column
                you should fill the <code>County</code> column with the value on the right of the table.</p></li>
              <li><p>In the first cell of the <code>County</code> column write the following formula <code>=VLOOKUP(V2,$AW$2:$AX$10,2,FALSE)</code>.
                The <code>V2</code> refers to where the <code>Violation County</code> value is, the <code>$AW$2:$AX$10</code> point to the table
                we created (the <code>$</code> signs make sure that even if the formula is copied it will always point to those fields), the
                <code>2</code> tells the program to place the second value in the table as the result, and the <code>FALSE</code> makes sure that
                only exact matches are used.</p></li>
              <li><p>Once the formula works for the first cell, copy it for the whole column and then, just as we did with the concatenation formula,
                copy the whole column and paste it again as values only.</p></li>
              <li><p>Once this is done, delete the table that we added.</p></li>
            </ul>
            <li><p>Finally, save your file as a <code>Windows Comma Separated (.csv)</code> file. If you are working with Google Sheets,
              download your file as <code>Comma-separated values</code>.</p></li>
          </ul>
        </div>
        <div class="section">
          <span class="anchor" id="geocoding"></span>
          <h1 class="page-header">Geocoding</h1>
          <p>Now, finally, we are ready to go to QGIS and start geocoding.</p>
          <ul>
            <li><p>The first step is to open QGIS and download the <a href="http://michaelminn.com/linux/mmqgis/">MMQGIS</a> plugin. To do this
              click on <code>Plugins</code> and select <code>Manage and Install Plugins...</code></p></li>
            <li><p>Once the list of plugins has been refreshed, look for the <code>MMQGIS</code> plugin and install it.</p></li>
            <img class="img-responsive" src="tutorialImages/08_Geocoding/01_MMQGIS.png" alt="thumb">
            <li><p>Now, open a new map and add the <code>Boroughs</code> shapefile. This is not necessary but it will help us verify the results of the geocoding.</p></li>
            <li><p>Finally, open the geocoding window by clicking on <code>MMQGIS</code> and selecting <code>Geocode</code> and <code>
              Geocode CSV with Google/OpenStreetMap</code></p></li>
            <img class="img-responsive" src="tutorialImages/08_Geocoding/02_GeocodeCSV.png" alt="thumb">
            <li><p>Now select the file that we prepared as the input, and the appropriate fields for address, county, city, and state.</p></li>
            <li><p>Leave the web service as <code>Google Maps</code> initially. If this one doesn't work, you can try the <code>OpenStretMaps/Nominatim</code>.</p></li>
            <li><p>And set the <code>Output Shapefile</code> as well as the <code>Not Found Output List</code>.</p></li>
            <img class="img-responsive" src="tutorialImages/08_Geocoding/03_FinalMenu.png" alt="thumb">
            <li><p>Once you are ready click <code>OK</code> (and cross your fingers...). It will take a while because the plugin takes into account
              the limits of the API and delays the request accordingly. For our 300 or so requests it should take between 5 and 10 minutes.</p></li>
            <li><p>Once the geocoding process finishes you should have a new layer in your map with your geocoded points. This layer will still have all the
              data present in the base file. In addition, you should also have on your computer (wherever you placed it) a file with the records that
              were the service was unable to geocode.</p></li>
          </ul>
        </div>
        <div class="section">
          <span class="anchor" id="additional"></span>
          <h1 class="page-header">Additional Options</h1>
          <ul>
            <li><p>In many cases you might need to geocode more than two or three hundred records. In these cases you should probably use
              your own Google Maps Geocoding API key. However, remember that even if you use your own key, Google still has a limit of
              50 requests per minute and a total of 2,500 requests per day.</p></li>
            <li><p>To obtain a key you should use a Google account to
              access the <a href="https://developers.google.com/">Google Developer Console</a>. Once you sign in, you should go to the
              Google API Console (link at the bottom of the Google Developer Console page) and create a new project.</p></li>
            <li><p>Once the project has been created, click on <code>Enable APIs and Services</code>, search for "geocoding" and
              once you find it, enable the <code>Google Maps Geocoding API</code> for this project.</p></li>
            <li><p>Finally, return to your Google API project page and on the left hand panel click on <code>Credentials</code>. There,
              click on <code>Create credentials</code> and choose <code>API key</code> from the dropdown menu. This is the key
              you should add to the MMQGIS plugin menu when geocoding.</p></li>
          </ul>
        </div>
      </div>
      <div class="col-md-3" role="complementary" id="myScrollspy">
        <nav class="sidebar hidden-print hidden-sm hidden-xs" data-spy="affix" data-offset-top="420">
          <ul class="nav sidenav">
            <li><a href="#datasets">Datasets</a></li>
            <li><a href="#whatIsGeocoding">What is Geocoding</a></li>
            <li><a href="#downloadParking">Downloading Parking Violations</a></li>
            <li><a href="#formattingAddresses">Formatting Address Data</a></li>
            <li><a href="#geocoding">Geocoding</a></li>
            <li><a href="#additional">Additional Options</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="../js/bootstrap.min.js"></script>
</body>
</html>
